name: Flutter iOS Build for AltStore (DISABLED)

on:
  workflow_dispatch: # Ð¢Ð¾Ð»ÑŒÐºÐ¾ Ñ€ÑƒÑ‡Ð½Ð¾Ð¹ Ð·Ð°Ð¿ÑƒÑÐº

jobs:
  build:
    runs-on: macos-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.2'
          channel: 'stable'
          cache: true

      - name: Flutter Doctor
        run: flutter doctor -v

      - name: Clean project thoroughly
        run: |
          echo "ðŸ§¹ ÐŸÐ¾Ð»Ð½Ð°Ñ Ð¾Ñ‡Ð¸ÑÑ‚ÐºÐ° Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°..."
          flutter clean
          rm -rf build
          rm -rf ios/Pods 
          rm -rf ios/Podfile.lock
          rm -rf ios/.symlinks
          rm -rf ios/Flutter/Flutter.framework
          rm -rf ~/Library/Developer/Xcode/DerivedData/*
          
      - name: Get Flutter dependencies
        run: |
          echo "ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Flutter Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹..."
          flutter pub get

      - name: Analyze Flutter code
        run: |
          echo "ðŸ” ÐÐ½Ð°Ð»Ð¸Ð· ÐºÐ¾Ð´Ð°..."
          flutter analyze --no-fatal-infos || echo "âš ï¸ Ð•ÑÑ‚ÑŒ Ð¿Ñ€ÐµÐ´ÑƒÐ¿Ñ€ÐµÐ¶Ð´ÐµÐ½Ð¸Ñ Ð² ÐºÐ¾Ð´Ðµ, Ð½Ð¾ ÑÑ‚Ð¾ Ð½Ðµ ÐºÑ€Ð¸Ñ‚Ð¸Ñ‡Ð½Ð¾ Ð´Ð»Ñ ÑÐ±Ð¾Ñ€ÐºÐ¸"

      - name: Setup CocoaPods with enhanced error handling
        run: |
          echo "ðŸŽ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° CocoaPods Ñ ÑƒÐ»ÑƒÑ‡ÑˆÐµÐ½Ð½Ð¾Ð¹ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¾Ð¹ Ð¾ÑˆÐ¸Ð±Ð¾Ðº..."
          cd ios
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð²ÐµÑ€ÑÐ¸ÑŽ CocoaPods Ð¸ Ruby
          echo "=== ENVIRONMENT CHECK ==="
          echo "CocoaPods Ð²ÐµÑ€ÑÐ¸Ñ: $(pod --version)"
          echo "Ruby Ð²ÐµÑ€ÑÐ¸Ñ: $(ruby --version)"
          echo "Gem Ð²ÐµÑ€ÑÐ¸Ñ: $(gem --version)"
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Podfile Ð½Ð° ÑÐ¸Ð½Ñ‚Ð°ÐºÑÐ¸Ñ‡ÐµÑÐºÐ¸Ðµ Ð¾ÑˆÐ¸Ð±ÐºÐ¸
          echo "=== PODFILE VALIDATION ==="
          echo "ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÐ¸Ð½Ñ‚Ð°ÐºÑÐ¸ÑÐ° Podfile..."
          if ruby -c Podfile > /dev/null 2>&1;
 then
            echo "âœ… Podfile ÑÐ¸Ð½Ñ‚Ð°ÐºÑÐ¸Ñ‡ÐµÑÐºÐ¸ ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚ÐµÐ½"
          else
            echo "âŒ ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐ¸Ð½Ñ‚Ð°ÐºÑÐ¸ÑÐ° Ð² Podfile"
            ruby -c Podfile
            exit 1
          fi
          
          # ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° Ð¿ÐµÑ€ÐµÐ´ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¾Ð¹
          echo "=== CLEANUP ==="
          rm -rf Pods Podfile.lock .symlinks
          
          # ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹ CocoaPods
          echo "=== REPO UPDATE ==="
          echo "ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ CocoaPods..."
          pod repo update --silent
          
          # ÐŸÐ¾Ð¿Ñ‹Ñ‚ÐºÐ° ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸ Ñ Ð¾ÑÐ½Ð¾Ð²Ð½Ñ‹Ð¼ Podfile
          echo "=== PRIMARY PODFILE INSTALL ==="
          echo "ÐŸÐ¾Ð¿Ñ‹Ñ‚ÐºÐ° ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸ Ñ Ð¾ÑÐ½Ð¾Ð²Ð½Ñ‹Ð¼ Podfile..."
          
          # Ð—Ð°Ð¿ÑƒÑÐº Ñ Ð´ÐµÑ‚Ð°Ð»ÑŒÐ½Ñ‹Ð¼ Ð»Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸ÐµÐ¼ Ð¾ÑˆÐ¸Ð±Ð¾Ðº
          if pod install --repo-update --verbose --clean-install 2>&1 | tee ../pod_install.log;
 then
            echo "âœ… ÐžÑÐ½Ð¾Ð²Ð½Ð¾Ð¹ Podfile ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾"
            PODFILE_SUCCESS=true
          else
            echo "âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ñ Ð¾ÑÐ½Ð¾Ð²Ð½Ñ‹Ð¼ Podfile"
            PODFILE_SUCCESS=false
            
            # ÐÐ½Ð°Ð»Ð¸Ð· Ð¾ÑˆÐ¸Ð±ÐºÐ¸
            echo "=== ERROR ANALYSIS ==="
            echo "ÐŸÐ¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ 20 ÑÑ‚Ñ€Ð¾Ðº Ð»Ð¾Ð³Ð° pod install:"
            tail -20 ../pod_install.log
            
            echo "ÐŸÐ¾Ð¸ÑÐº ÐºÐ»ÑŽÑ‡ÐµÐ²Ñ‹Ñ… Ð¾ÑˆÐ¸Ð±Ð¾Ðº:"
            grep -i "error\|exception\|abort" ../pod_install.log | head -5 || echo "Ð¡Ð¿ÐµÑ†Ð¸Ñ„Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ Ð¾ÑˆÐ¸Ð±ÐºÐ¸ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ñ‹"
          fi
          
          # Fallback Ð½Ð° Ð¼Ð¸Ð½Ð¸Ð¼Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Podfile
          if [ "$PODFILE_SUCCESS" = "false" ]; then
            echo "=== FALLBACK TO MINIMAL PODFILE ==="
            echo "ÐŸÐµÑ€ÐµÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ð½Ð° Ð¼Ð¸Ð½Ð¸Ð¼Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Podfile..."
            
            # Ð‘ÑÐºÐ°Ð¿ Ð¾ÑÐ½Ð¾Ð²Ð½Ð¾Ð³Ð¾ Podfile
            cp Podfile Podfile.backup
            
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ Ð¼Ð¸Ð½Ð¸Ð¼Ð°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Podfile
            if [ ! -f "Podfile.minimal" ]; then
              echo "âŒ Podfile.minimal Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½, ÑÐ¾Ð·Ð´Ð°ÐµÐ¼ Ð±Ð°Ð·Ð¾Ð²Ñ‹Ð¹..."
              cat > Podfile.minimal << 'EOF'
          platform :ios, '13.0'
          ENV['COCOAPODS_DISABLE_STATS'] = 'true'
          source 'https://cdn.cocoapods.org/'
          
          project 'Runner', {
            'Debug' => :debug,
            'Profile' => :release,
            'Release' => :release,
          }
          
          def flutter_root
            generated_xcode_build_settings_path = File.expand_path(File.join('..', 'Flutter', 'Generated.xcconfig'), __FILE__)
            unless File.exist?(generated_xcode_build_settings_path)
              raise "Generated.xcconfig must exist. If you're running pod install manually, make sure flutter pub get is executed first"
            end
          
            File.foreach(generated_xcode_build_settings_path) do |line|
              matches = line.match(/FLUTTER_ROOT=(.*)/)
              return matches[1].strip if matches
            end
            raise "FLUTTER_ROOT not found in Generated.xcconfig"
          end
          
          require File.expand_path(File.join('packages', 'flutter_tools', 'bin', 'podhelper'), flutter_root)
          
          flutter_ios_podfile_setup
          
          target 'Runner' do
            use_frameworks!
            use_modular_headers!
            flutter_install_all_ios_pods File.dirname(File.realpath(__FILE__)))
          end
          
          post_install do |installer|
            installer.pods_project.targets.each do |target|
              flutter_additional_ios_build_settings(target)
            end
          end
          EOF
            fi
            
            # Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ð¼Ð¸Ð½Ð¸Ð¼Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Podfile
            cp Podfile.minimal Podfile
            
            # ÐžÑ‡Ð¸Ñ‰Ð°ÐµÐ¼ Ð¸ Ð¿Ñ€Ð¾Ð±ÑƒÐµÐ¼ ÑÐ½Ð¾Ð²Ð°
            rm -rf Pods Podfile.lock .symlinks
            
            echo "Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ñ Ð¼Ð¸Ð½Ð¸Ð¼Ð°Ð»ÑŒÐ½Ñ‹Ð¼ Podfile..."
            if pod install --repo-update --verbose --clean-install 2>&1 | tee ../pod_install_minimal.log;
 then
              echo "âœ… ÐœÐ¸Ð½Ð¸Ð¼Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Podfile ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾"
            else
              echo "âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð´Ð°Ð¶Ðµ Ñ Ð¼Ð¸Ð½Ð¸Ð¼Ð°Ð»ÑŒÐ½Ñ‹Ð¼ Podfile"
              echo "Ð›Ð¾Ð³ Ð¼Ð¸Ð½Ð¸Ð¼Ð°Ð»ÑŒÐ½Ð¾Ð¹ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸:"
              tail -30 ../pod_install_minimal.log
              exit 1
            fi
          fi
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚
          echo "=== INSTALLATION VERIFICATION ==="
          echo "ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ‹Ñ… pods:"
          if [ -d "Pods" ]; then
            echo "âœ… ÐŸÐ°Ð¿ÐºÐ° Pods ÑÐ¾Ð·Ð´Ð°Ð½Ð°"
            echo "ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ‹Ñ… pods: $(ls Pods/ | wc -l)"
            ls -la Pods/ | head -10
          else
            echo "âŒ ÐŸÐ°Ð¿ÐºÐ° Pods Ð½Ðµ ÑÐ¾Ð·Ð´Ð°Ð½Ð°"
            exit 1
          fi
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ workspace
          if [ -f "Runner.xcworkspace/contents.xcworkspacedata" ]; then
            echo "âœ… Workspace ÑÐ¾Ð·Ð´Ð°Ð½ ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð¾"
          else
            echo "âŒ Workspace Ð½Ðµ ÑÐ¾Ð·Ð´Ð°Ð½ Ð¸Ð»Ð¸ Ð¿Ð¾Ð²Ñ€ÐµÐ¶Ð´ÐµÐ½"
            exit 1
          fi

      - name: Check dependencies status
        run: |
          echo "ðŸ“Š ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹..."
          flutter pub outdated || true
          cd ios && pod outdated || true
          
      - name: Verify iOS project structure
        run: |
          echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñ‹ iOS Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°..."
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÐºÐ»ÑŽÑ‡ÐµÐ²Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹
          echo "ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÐºÐ»ÑŽÑ‡ÐµÐ²Ñ‹Ñ… Ñ„Ð°Ð¹Ð»Ð¾Ð²:"
          ls -la ios/Runner.xcodeproj/project.pbxproj && echo "âœ… project.pbxproj Ð½Ð°Ð¹Ð´ÐµÐ½" || echo "âŒ project.pbxproj Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚"
          ls -la ios/Runner/Info.plist && echo "âœ… Info.plist Ð½Ð°Ð¹Ð´ÐµÐ½" || echo "âŒ Info.plist Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚"
          ls -la ios/Pods/ && echo "âœ… Pods ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹" || echo "âŒ Pods Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÑŽÑ‚"
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Firebase ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ
          echo "ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Firebase ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸:"
          if [ -f "ios/Runner/GoogleService-Info.plist" ]; then
            echo "âœ… GoogleService-Info.plist Ð½Ð°Ð¹Ð´ÐµÐ½"
          else
            echo "âš ï¸ GoogleService-Info.plist Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚, ÐºÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ð¸Ð· ÐºÐ¾Ñ€Ð½Ñ..."
            if [ -f "google-service-info.json" ]; then
              cp google-service-info.json ios/Runner/GoogleService-Info.plist
              echo "âœ… GoogleService-Info.plist ÑÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½"
            else
              echo "âŒ Ð¤Ð°Ð¹Ð» Firebase ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½"
            fi
          fi
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Flutter ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ
          echo "ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Flutter ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸:"
          ls -la ios/Flutter/Generated.xcconfig && echo "âœ… Generated.xcconfig Ð½Ð°Ð¹Ð´ÐµÐ½" || echo "âŒ Generated.xcconfig Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚"
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ workspace
          echo "ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° workspace:"
          ls -la ios/Runner.xcworkspace/ && echo "âœ… Workspace Ð½Ð°Ð¹Ð´ÐµÐ½" || echo "âŒ Workspace Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚"

      - name: Pre-build system diagnosis
        run: |
          echo "ðŸ” PRE-BUILD SYSTEM DIAGNOSIS"
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÐ¸ÑÑ‚ÐµÐ¼Ð½Ñ‹Ñ… Ñ€ÐµÑÑƒÑ€ÑÐ¾Ð²
          echo "=== SYSTEM RESOURCES ==="
          df -h
          echo "Available disk space: $(df -h . | tail -1 | awk '{print $4}')"
          vm_stat | head -5
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¸Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚Ð¾Ð²
          echo "=== DEVELOPMENT TOOLS ==="
          xcode-select -p
          xcrun --show-sdk-path
          xcrun --show-sdk-version
          echo "Flutter: $(flutter --version --machine 2>/dev/null | head -1 || flutter --version | head -1)"
          echo "Dart: $(dart --version 2>&1 | head -1)"
          echo "Xcode: $(xcodebuild -version | head -1)"
          echo "CocoaPods: $(pod --version)"
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
          echo "=== PROJECT VALIDATION ==="
          echo "Bundle identifier check:"
          grep -r "PRODUCT_BUNDLE_IDENTIFIER" ios/Runner.xcodeproj/ | head -3
          echo "Info.plist bundle check:"
          plutil -p ios/Runner/Info.plist | grep -i bundle || echo "No bundle info found"

      - name: Enhanced IPA build with full diagnostics
        run: |
          echo "ðŸ”¨ ENHANCED IPA BUILD WITH FULL DIAGNOSTICS"
          
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñƒ Ð´Ð»Ñ Ð´ÐµÑ‚Ð°Ð»ÑŒÐ½Ñ‹Ñ… Ð»Ð¾Ð³Ð¾Ð²
          mkdir -p logs/{flutter,xcode,system,analysis}
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð³Ð¾Ñ‚Ð¾Ð²Ð½Ð¾ÑÑ‚ÑŒ Ðº ÑÐ±Ð¾Ñ€ÐºÐµ
          if [ ! -d "ios/Pods" ]; then
            echo "âŒ ÐžÑˆÐ¸Ð±ÐºÐ°: CocoaPods Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹"
            exit 1
          fi
          
          # ÐœÐ¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³ ÑÐ¸ÑÑ‚ÐµÐ¼Ð½Ñ‹Ñ… Ñ€ÐµÑÑƒÑ€ÑÐ¾Ð² Ð² Ñ„Ð¾Ð½Ðµ
          (while true; do
            echo "$(date): Disk: $(df -h . | tail -1 | awk '{print $4}'), Memory: $(vm_stat | grep 'Pages free' | awk '{print $3}')" >> logs/system/resources.log
            sleep 15
          done) &
          MONITOR_PID=$!
          
          # ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° unsigned ÑÐ±Ð¾Ñ€ÐºÐ¸
          echo "âš™ï¸ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð´Ð»Ñ unsigned ÑÐ±Ð¾Ñ€ÐºÐ¸..."
          cat > ios/Flutter/Unsigned.xcconfig << 'EOF'
          #include "Generated.xcconfig"
          CODE_SIGN_IDENTITY=
          CODE_SIGNING_REQUIRED=NO
          CODE_SIGNING_ALLOWED=NO
          PROVISIONING_PROFILE_SPECIFIER=
          DEVELOPMENT_TEAM=
          ENABLE_BITCODE=NO
          SKIP_INSTALL=NO
          EOF
          
          # Ð‘ÑÐºÐ°Ð¿ Ð¸ Ð·Ð°Ð¼ÐµÐ½Ð° ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸
          cp ios/Flutter/Release.xcconfig ios/Flutter/Release.xcconfig.backup
          cp ios/Flutter/Unsigned.xcconfig ios/Flutter/Release.xcconfig
          
          echo "ðŸ“‹ ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ Ð¿ÐµÑ€ÐµÐ´ ÑÐ±Ð¾Ñ€ÐºÐ¾Ð¹:"
          echo "Generated.xcconfig:"
          cat ios/Flutter/Generated.xcconfig || echo "Generated.xcconfig Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½"
          echo "Release.xcconfig:"
          cat ios/Flutter/Release.xcconfig
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð°Ñ‡Ð°Ð»ÑŒÐ½Ð¾Ð³Ð¾ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ
          echo "ðŸ“ ÐÐ°Ñ‡Ð°Ð»ÑŒÐ½Ð¾Ðµ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ build/":"
          ls -la build/ 2>/dev/null || echo "ÐŸÐ°Ð¿ÐºÐ° build Ð½Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚"
          
          # ÐžÐ¡ÐÐžÐ’ÐÐÐ¯ Ð¡Ð‘ÐžÐ ÐšÐ Ñ Ð´ÐµÑ‚Ð°Ð»ÑŒÐ½Ñ‹Ð¼ Ð»Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸ÐµÐ¼
          echo "ðŸš€ Ð—Ð°Ð¿ÑƒÑÐº flutter build ipa Ñ Ð¼Ð°ÐºÑÐ¸Ð¼Ð°Ð»ÑŒÐ½Ð¾Ð¹ Ð´ÐµÑ‚Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸ÐµÐ¹..."
          
          # Ð—Ð°Ð¿ÑƒÑÐº Ñ Ñ€Ð°Ð·Ð´ÐµÐ»ÐµÐ½Ð¸ÐµÐ¼ stdout Ð¸ stderr
          flutter build ipa --release --no-codesign --verbose \
            > logs/flutter/stdout.log 2> logs/flutter/stderr.log
          
          FLUTTER_EXIT_CODE=$?
          
          # ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³ Ñ€ÐµÑÑƒÑ€ÑÐ¾Ð²
          kill $MONITOR_PID 2>/dev/null || true
          
          echo "Flutter build exit code: $FLUTTER_EXIT_CODE"
          
          # ÐÐ•ÐœÐ•Ð”Ð›Ð•ÐÐÐ«Ð™ ÐÐÐÐ›Ð˜Ð— Ð Ð•Ð—Ð£Ð›Ð¬Ð¢ÐÐ¢Ð
          echo "ðŸ” IMMEDIATE RESULT ANALYSIS"
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ„Ð°Ð¹Ð»Ð¾Ð²Ð¾Ð¹ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹
          echo "=== FILE SYSTEM CHECK ==="
          echo "All files in build/":"
          find build/ -type f 2>/dev/null | sort || echo "No files in build/"
          
          echo "IPA files search:"
          find . -name "*.ipa" -type f -exec ls -lh {} \; 2>/dev/null || echo "No IPA files found anywhere"
          
          echo "Archive files search:"
          find build/ -name "*.xcarchive" -type d 2>/dev/null || echo "No xcarchive files found"
          
          echo "App bundle search:"
          find build/ -name "*.app" -type d 2>/dev/null || echo "No app bundles found"
          
          # ÐÐÐÐ›Ð˜Ð— Ð›ÐžÐ“ÐžÐ’ ÐÐ Ð¡ÐšÐ Ð«Ð¢Ð«Ð• ÐžÐ¨Ð˜Ð‘ÐšÐ˜
          echo "ðŸ” LOG ANALYSIS FOR HIDDEN ERRORS"
          
          echo "=== FLUTTER STDOUT ANALYSIS ==="
          if [ -f logs/flutter/stdout.log ]; then
            echo "Last 30 lines of stdout:"
            tail -30 logs/flutter/stdout.log
            
            echo "Success indicators search:"
            grep -i "built.*ipa\|archive.*success\|export.*success" logs/flutter/stdout.log || echo "âŒ No success indicators found"
            
            echo "Warning indicators:"
            grep -i "warning\|caution" logs/flutter/stdout.log | head -5 || echo "No warnings found"
          fi
          
          echo "=== FLUTTER STDERR ANALYSIS ==="
          if [ -f logs/flutter/stderr.log ]; then
            echo "Stderr content:"
            cat logs/flutter/stderr.log
            
            echo "Hidden error search:"
            grep -i "error\|fail\|exception\|abort\|denied" logs/flutter/stderr.log || echo "No explicit errors in stderr"
          fi
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ÑÑ‚Ð¸ Ð¾ÑÐ½Ð¾Ð²Ð½Ð¾Ð¹ ÑÐ±Ð¾Ñ€ÐºÐ¸
          IPA_FOUND=false
          if [ -f "build/ios/ipa/Runner.ipa" ] || [ -f "build/ios/ipa/taste_smoke_ios.ipa" ] || ls build/ios/ipa/*.ipa 1> /dev/null 2>&1;
 then
            echo "âœ… IPA Ñ„Ð°Ð¹Ð» Ð½Ð°Ð¹Ð´ÐµÐ½ Ð² build/ios/ipa/"
            IPA_FOUND=true
          fi
          
          # ÐÐ›Ð¬Ð¢Ð•Ð ÐÐÐ¢Ð˜Ð’ÐÐ«Ð• ÐœÐ•Ð¢ÐžÐ”Ð« Ð¡Ð‘ÐžÐ ÐšÐ˜
          if [ "$IPA_FOUND" = "false" ]; then
            echo "ðŸ”„ IPA ÐÐ• ÐÐÐ™Ð”Ð•Ð - ÐŸÐ ÐžÐ‘Ð£Ð•Ðœ ÐÐ›Ð¬Ð¢Ð•Ð ÐÐÐ¢Ð˜Ð’ÐÐ«Ð• ÐœÐ•Ð¢ÐžÐ”Ð«"
            
            # Ð’Ð¾ÑÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð¾Ñ€Ð¸Ð³Ð¸Ð½Ð°Ð»ÑŒÐ½ÑƒÑŽ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ
            cp ios/Flutter/Release.xcconfig.backup ios/Flutter/Release.xcconfig
            
            # ÐœÐµÑ‚Ð¾Ð´ 1: ÐŸÑ€ÑÐ¼Ð¾Ð¹ xcodebuild
            echo "=== METHOD 1: Direct xcodebuild ==="
            cd ios
            
            echo "Cleaning with xcodebuild..."
            xcodebuild clean -workspace Runner.xcworkspace -scheme Runner -configuration Release \
              > ../logs/xcode/clean.log 2>&1
            
            echo "Building archive with xcodebuild..."
            xcodebuild archive \
              -workspace Runner.xcworkspace \
              -scheme Runner \
              -configuration Release \
              -archivePath build/Runner.xcarchive \
              CODE_SIGN_IDENTITY=""
              CODE_SIGNING_REQUIRED=NO \
              CODE_SIGNING_ALLOWED=NO \
              ENABLE_BITCODE=NO \
              > ../logs/xcode/archive.log 2>&1
            
            ARCHIVE_EXIT_CODE=$?
            echo "Archive exit code: $ARCHIVE_EXIT_CODE"
            
            if [ $ARCHIVE_EXIT_CODE -eq 0 ] && [ -d "build/Runner.xcarchive" ]; then
              echo "âœ… Archive created successfully"
              
              # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ export options
              cat > export_options.plist << 'EOF'
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>method</key>
    <string>development</string>
    <key>signingStyle</key>
    <string>manual</string>
    <key>stripSwiftSymbols</key>
    <false/>
</dict>
</plist>
EOF
              
              echo "Exporting to IPA..."
              xcodebuild -exportArchive \
                -archivePath build/Runner.xcarchive \
                -exportPath ../build/ios/ipa \
                -exportOptionsPlist export_options.plist \
                > ../logs/xcode/export.log 2>&1
              
              EXPORT_EXIT_CODE=$?
              echo "Export exit code: $EXPORT_EXIT_CODE"
              
              if [ $EXPORT_EXIT_CODE -eq 0 ]; then
                echo "âœ… Direct xcodebuild method succeeded"
                IPA_FOUND=true
              fi
            else
              echo "âŒ Archive creation failed"
              echo "Archive log (last 20 lines):"
              tail -20 ../logs/xcode/archive.log
            fi
            
            cd ..
            
            # ÐœÐµÑ‚Ð¾Ð´ 2: Flutter build ios + manual IPA
            if [ "$IPA_FOUND" = "false" ]; then
              echo "=== METHOD 2: Flutter build ios + manual IPA ==="
              
              flutter build ios --release --no-codesign --verbose \
                > logs/flutter/build_ios_stdout.log 2> logs/flutter/build_ios_stderr.log
              
              IOS_BUILD_EXIT_CODE=$?
              echo "Flutter build ios exit code: $IOS_BUILD_EXIT_CODE"
              
              if [ $IOS_BUILD_EXIT_CODE -eq 0 ] && [ -d "build/ios/iphoneos" ]; then
                echo "âœ… iOS build successful, creating IPA manually..."
                
                cd build/ios/iphoneos
                APP_NAME=$(find . -name "*.app" -type d | head -1)
                
                if [ -n "$APP_NAME" ]; then
                  echo "Found app: $APP_NAME"
                  echo "App bundle size: $(du -sh "$APP_NAME" | cut -f1)"
                  
                  # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ IPA ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñƒ
                  mkdir -p ../ipa/Payload
                  cp -r "$APP_NAME" ../ipa/Payload/
                  
                  cd ../ipa
                  zip -r "taste_smoke_ios.ipa" Payload/ > /dev/null
                  
                  if [ -f "taste_smoke_ios.ipa" ]; then
                    echo "âœ… Manual IPA created: $(ls -lh taste_smoke_ios.ipa)"
                    IPA_FOUND=true
                  fi
                  
                  cd ../../..
                else
                  echo "âŒ No .app bundle found in build/ios/iphoneos"
                  ls -la build/ios/iphoneos/
                  cd ../../..
                fi
              else
                echo "âŒ Flutter build ios failed"
                echo "iOS build stderr:"
                cat logs/flutter/build_ios_stderr.log
              fi
            fi
          fi
          
          # Ð¤Ð˜ÐÐÐ›Ð¬ÐÐÐ¯ ÐŸÐ ÐžÐ’Ð•Ð ÐšÐ Ð˜ Ð’ÐÐ›Ð˜Ð”ÐÐ¦Ð˜Ð¯
          echo "ðŸŽ¯ FINAL VALIDATION"
          
          if [ "$IPA_FOUND" = "true" ] && [ -d "build/ios/ipa" ] && ls build/ios/ipa/*.ipa 1> /dev/null 2>&1;
 then
            echo "âœ… IPA Ð¤ÐÐ™Ð› Ð£Ð¡ÐŸÐ•Ð¨ÐÐž Ð¡ÐžÐ—Ð”ÐÐ!"
            
            for ipa in build/ios/ipa/*.ipa;
 do
              echo "ðŸ“± IPA: $ipa"
              echo "   Ð Ð°Ð·Ð¼ÐµÑ€: $(du -h "$ipa" | cut -f1)"
              echo "   Ð¢Ð¸Ð¿ Ñ„Ð°Ð¹Ð»Ð°: $(file "$ipa")"
              
              # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ð³Ð¾ IPA
              echo "   Ð¡Ð¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ (Ð¿ÐµÑ€Ð²Ñ‹Ðµ 10 Ñ„Ð°Ð¹Ð»Ð¾Ð²):"
              unzip -l "$ipa" | head -15 | tail -10
              
              # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð° ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð¾ÑÑ‚ÑŒ
              if unzip -l "$ipa" | grep -q "Payload/.*\.app/"; then
                echo "   âœ… IPA ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ñ‚ ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½ÑƒÑŽ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñƒ"
              else
                echo "   âš ï¸ IPA Ð¼Ð¾Ð¶ÐµÑ‚ Ð±Ñ‹Ñ‚ÑŒ Ð½ÐµÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ñ‹Ð¼"
              fi
            done
          else
            echo "âŒ IPA Ð¤ÐÐ™Ð› ÐÐ• Ð‘Ð«Ð› Ð¡ÐžÐ—Ð”ÐÐ ÐÐ˜ÐšÐÐšÐ˜Ðœ ÐœÐ•Ð¢ÐžÐ”ÐžÐœ"
            echo ""
            echo "=== FINAL DIAGNOSTICS ==="
            echo "Build directory structure:"
            find build/ -type f 2>/dev/null | head -30
            echo ""
            echo "System resources at end:"
            df -h . | tail -1
            echo ""
            echo "Check logs in artifacts for detailed analysis"
            exit 1
          fi
          
      - name: Verify IPA creation and validate
        run: |
          echo "ðŸ” Ð”ÐµÑ‚Ð°Ð»ÑŒÐ½Ð°Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¸ Ð²Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ñ IPA..."
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñƒ build Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸
          echo "=== ÐŸÐ¾Ð»Ð½Ð°Ñ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð° build/ ==="
          find build/ -type f 2>/dev/null | sort || echo "ÐŸÐ°Ð¿ÐºÐ° build Ð¿ÑƒÑÑ‚Ð° Ð¸Ð»Ð¸ Ð½Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚"
          
          echo ""
          echo "=== ÐŸÐ¾Ð¸ÑÐº Ð²ÑÐµÑ… IPA Ñ„Ð°Ð¹Ð»Ð¾Ð² ==="
          find . -name "*.ipa" -type f 2>/dev/null || echo "IPA Ñ„Ð°Ð¹Ð»Ñ‹ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ñ‹ Ð½Ð¸Ð³Ð´Ðµ Ð² Ð¿Ñ€Ð¾ÐµÐºÑ‚Ðµ"
          
          echo ""
          echo "=== ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿Ð°Ð¿ÐºÐ¸ build/ios/ipa ==="
          if [ -d "build/ios/ipa" ]; then
            echo "âœ… ÐŸÐ°Ð¿ÐºÐ° build/ios/ipa ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚"
            ls -la build/ios/ipa/
            
            if ls build/ios/ipa/*.ipa 1> /dev/null 2>&1;
 then
              echo ""
              echo "âœ… IPA Ñ„Ð°Ð¹Ð»Ñ‹ Ð½Ð°Ð¹Ð´ÐµÐ½Ñ‹! Ð”ÐµÑ‚Ð°Ð»ÑŒÐ½Ð°Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ°:"
              
              for ipa in build/ios/ipa/*.ipa;
 do
                echo ""
                echo "ðŸ“± ÐÐ½Ð°Ð»Ð¸Ð· IPA: $ipa"
                echo "   ðŸ“ Ð Ð°Ð·Ð¼ÐµÑ€: $(du -h "$ipa" | cut -f1)"
                echo "   ðŸ” Ð¢Ð¸Ð¿ Ñ„Ð°Ð¹Ð»Ð°: $(file "$ipa")"
                
                # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ñ‡Ñ‚Ð¾ ÑÑ‚Ð¾ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ ZIP Ð°Ñ€Ñ…Ð¸Ð²
                if file "$ipa" | grep -q "Zip archive"; then
                  echo "   âœ… ÐšÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ñ‹Ð¹ ZIP Ð°Ñ€Ñ…Ð¸Ð²"
                  
                  # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ IPA
                  echo "   ðŸ“¦ Ð¡Ð¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ IPA (Ð¿ÐµÑ€Ð²Ñ‹Ðµ 15 Ñ„Ð°Ð¹Ð»Ð¾Ð²):"
                  unzip -l "$ipa" | head -20 | tail -15
                  
                  # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ñ… ÐºÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚Ð¾Ð²
                  echo "   ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ñ… ÐºÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚Ð¾Ð²:"
                  
                  if unzip -l "$ipa" | grep -q "Payload/.*\.app/"; then
                    echo "   âœ… App bundle Ð½Ð°Ð¹Ð´ÐµÐ½ Ð² Payload/"
                  else
                    echo "   âŒ App bundle Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½ Ð² Payload/"
                  fi
                  
                  if unzip -l "$ipa" | grep -q "Payload/.*\.app/Info.plist"; then
                    echo "   âœ… Info.plist Ð½Ð°Ð¹Ð´ÐµÐ½"
                  else
                    echo "   âŒ Info.plist Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½"
                  fi
                  
                  if unzip -l "$ipa" | grep -q "Payload/.*\.app/.*"; then
                    APP_BUNDLE=$(unzip -l "$ipa" | grep "Payload/.*\.app/" | head -1 | awk '{print $4}' | cut -d'/' -f2)
                    echo "   ðŸ“± Ð˜Ð¼Ñ app bundle: $APP_BUNDLE"
                  fi
                  
                  # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ€Ð°Ð·Ð¼ÐµÑ€ - Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ Ð±Ð¾Ð»ÑŒÑˆÐµ 1MB Ð´Ð»Ñ Ñ€ÐµÐ°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ
                  SIZE_BYTES=$(stat -f%z "$ipa" 2>/dev/null || stat -c%s "$ipa" 2>/dev/null || echo "0")
                  SIZE_MB=$((SIZE_BYTES / 1024 / 1024))
                  
                  if [ "$SIZE_MB" -gt 1 ]; then
                    echo "   âœ… Ð Ð°Ð·Ð¼ÐµÑ€ IPA ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ñ‹Ð¹: ${SIZE_MB}MB"
                  else
                    echo "   âš ï¸ IPA ÑÐ»Ð¸ÑˆÐºÐ¾Ð¼ Ð¼Ð°Ð»ÐµÐ½ÑŒÐºÐ¸Ð¹: ${SIZE_MB}MB (Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾, Ð½ÐµÐ¿Ð¾Ð»Ð½Ñ‹Ð¹)"
                  fi
                  
                else
                  echo "   âŒ Ð¤Ð°Ð¹Ð» Ð½Ðµ ÑÐ²Ð»ÑÐµÑ‚ÑÑ ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ñ‹Ð¼ ZIP Ð°Ñ€Ñ…Ð¸Ð²Ð¾Ð¼"
                  echo "   ðŸ” Ð¡Ð¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ Ñ„Ð°Ð¹Ð»Ð° (Ð¿ÐµÑ€Ð²Ñ‹Ðµ 100 Ð±Ð°Ð¹Ñ‚):"
                  hexdump -C "$ipa" | head -5
                fi
              done
              
              echo ""
              echo "ðŸŽ‰ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð° ÑƒÑÐ¿ÐµÑˆÐ½Ð¾!"
              
            else
              echo "âŒ IPA Ñ„Ð°Ð¹Ð»Ñ‹ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ñ‹ Ð² Ð¿Ð°Ð¿ÐºÐµ build/ios/ipa"
              echo "Ð¡Ð¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ Ð¿Ð°Ð¿ÐºÐ¸:"
              ls -la build/ios/ipa/ || echo "ÐÐµ ÑƒÐ´Ð°ÐµÑ‚ÑÑ Ð¿Ñ€Ð¾Ñ‡Ð¸Ñ‚Ð°Ñ‚ÑŒ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ Ð¿Ð°Ð¿ÐºÐ¸"
              exit 1
            fi
          else
            echo "âŒ ÐŸÐ°Ð¿ÐºÐ° build/ios/ipa Ð½Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚"
            echo ""
            echo "=== Ð”Ð¸Ð°Ð³Ð½Ð¾ÑÑ‚Ð¸ÐºÐ° Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²Ð¸Ñ IPA ==="
            echo "Ð’Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ñ‹Ðµ Ð¿Ñ€Ð¸Ñ‡Ð¸Ð½Ñ‹:"
            echo "1. flutter build ipa Ð½Ðµ Ð·Ð°Ð²ÐµÑ€ÑˆÐ¸Ð»ÑÑ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾"
            echo "2. ÐŸÑ€Ð¾Ð±Ð»ÐµÐ¼Ñ‹ Ñ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ°Ð¼Ð¸ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐ¸ ÐºÐ¾Ð´Ð°"
            echo "3. ÐžÑˆÐ¸Ð±ÐºÐ¸ Ð² Info.plist Ð¸Ð»Ð¸ bundle identifier"
            echo "4. ÐÐµÐ´Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ñ‡Ð½Ð¾ Ð¼ÐµÑÑ‚Ð° Ð½Ð° Ð´Ð¸ÑÐºÐµ"
            echo ""
            echo "ÐŸÐ¾Ð»Ð½Ð°Ñ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð° build/":"
            find build/ -type f 2>/dev/null | head -30 || echo "ÐŸÐ°Ð¿ÐºÐ° build Ð½Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚"
            exit 1
          fi

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: taste-smoke-ios-altstore
          path: build/ios/ipa/*.ipa
          retention-days: 30

      - name: Debug build failure
        if: failure()
        run: |
          echo "ðŸ” Ð”Ð¸Ð°Ð³Ð½Ð¾ÑÑ‚Ð¸ÐºÐ° Ð¾ÑˆÐ¸Ð±ÐºÐ¸ ÑÐ±Ð¾Ñ€ÐºÐ¸..."
          
          echo "=== Ð¡Ñ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð° Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð° ==="
          ls -la ios/
          
          echo "=== Ð¡Ñ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð° build ==="
          find build/ -type f 2>/dev/null || echo "ÐŸÐ°Ð¿ÐºÐ° build Ð½Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚"
          
          echo "=== Xcode Ð¿Ñ€Ð¾ÐµÐºÑ‚ ==="
          ls -la ios/Runner.xcodeproj/
          ls -la ios/Runner.xcworkspace/ 2>/dev/null || echo "Workspace Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½"
          
          echo "=== CocoaPods ==="
          ls -la ios/Pods/ 2>/dev/null || echo "Pods Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ñ‹"
          cat ios/Podfile.lock | head -20 2>/dev/null || echo "Podfile.lock Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½"
          
          echo "=== Flutter ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ ==="
          ls -la ios/Flutter/
          cat ios/Flutter/Generated.xcconfig 2>/dev/null || echo "Generated.xcconfig Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½"
          
          echo "=== ÐŸÐ¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ Ð»Ð¾Ð³Ð¸ ÑÐ±Ð¾Ñ€ÐºÐ¸ ==="
          find . -name "*.log" -mtime -1 2>/dev/null | head -5 | xargs tail -50 2>/dev/null || echo "Ð›Ð¾Ð³Ð¸ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ñ‹"

      - name: Upload Flutter build logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: flutter-build-logs
          path: |
            flutter_logs/
          retention-days: 7

      - name: Upload build logs (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-debug
          path: |
            ios/Pods/
            build/
            ios/Flutter/
            ios/Runner.xcodeproj/
            ios/Podfile*
            flutter_logs/
          retention-days: 7