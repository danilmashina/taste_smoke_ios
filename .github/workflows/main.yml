name: Flutter iOS Build for AltStore

on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch: # –ü–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –≤—Ä—É—á–Ω—É—é

jobs:
  build:
    runs-on: macos-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.2'
          channel: 'stable'
          cache: true

      - name: Flutter Doctor
        run: flutter doctor -v

      - name: Clean project thoroughly
        run: |
          echo "üßπ –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞..."
          flutter clean
          rm -rf build
          rm -rf ios/Pods 
          rm -rf ios/Podfile.lock
          rm -rf ios/.symlinks
          rm -rf ios/Flutter/Flutter.framework
          rm -rf ~/Library/Developer/Xcode/DerivedData/*
          
      - name: Get Flutter dependencies
        run: |
          echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Flutter –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
          flutter pub get

      - name: Analyze Flutter code
        run: |
          echo "üîç –ê–Ω–∞–ª–∏–∑ –∫–æ–¥–∞..."
          flutter analyze --no-fatal-infos || echo "‚ö†Ô∏è –ï—Å—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –≤ –∫–æ–¥–µ, –Ω–æ —ç—Ç–æ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è —Å–±–æ—Ä–∫–∏"

      - name: Setup CocoaPods
        run: |
          echo "üçé –ù–∞—Å—Ç—Ä–æ–π–∫–∞ CocoaPods..."
          cd ios
          
          # –û–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π CocoaPods
          pod repo update
          
          # –ü—Ä–æ–±—É–µ–º —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å –æ—Å–Ω–æ–≤–Ω—ã–º Podfile
          echo "–ü–æ–ø—ã—Ç–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å –æ—Å–Ω–æ–≤–Ω—ã–º Podfile..."
          if ! pod install --repo-update --verbose --clean-install; then
            echo "‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å –æ—Å–Ω–æ–≤–Ω—ã–º Podfile, –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π..."
            
            # –ë—ç–∫–∞–ø –æ—Å–Ω–æ–≤–Ω–æ–≥–æ Podfile
            cp Podfile Podfile.backup
            
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π Podfile
            cp Podfile.minimal Podfile
            
            # –û—á–∏—â–∞–µ–º –∏ –ø—Ä–æ–±—É–µ–º —Å–Ω–æ–≤–∞
            rm -rf Pods Podfile.lock
            pod install --repo-update --verbose --clean-install
          fi

      - name: Check dependencies status
        run: |
          echo "üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
          flutter pub outdated || true
          cd ios && pod outdated || true

      - name: Build iOS IPA (unsigned for AltStore)
        run: |
          echo "üî® –°–±–æ—Ä–∫–∞ IPA –¥–ª—è AltStore..."
          flutter build ipa --release --no-codesign --verbose
          
      - name: Verify IPA creation
        run: |
          echo "‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–∑–¥–∞–Ω–Ω–æ–≥–æ IPA..."
          ls -la build/ios/ipa/
          file build/ios/ipa/*.ipa

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: taste-smoke-ios-altstore
          path: build/ios/ipa/*.ipa
          retention-days: 30

      - name: Upload build logs (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: |
            ios/Pods/
            build/
          retention-days: 7
