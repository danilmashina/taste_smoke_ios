name: Flutter iOS Build for AltStore

on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch: # –ü–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –≤—Ä—É—á–Ω—É—é

jobs:
  build:
    runs-on: macos-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.2'
          channel: 'stable'
          cache: true

      - name: Flutter Doctor
        run: flutter doctor -v

      - name: Clean project thoroughly
        run: |
          echo "üßπ –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞..."
          flutter clean
          rm -rf build
          rm -rf ios/Pods 
          rm -rf ios/Podfile.lock
          rm -rf ios/.symlinks
          rm -rf ios/Flutter/Flutter.framework
          rm -rf ~/Library/Developer/Xcode/DerivedData/*
          
      - name: Get Flutter dependencies
        run: |
          echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Flutter –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
          flutter pub get

      - name: Analyze Flutter code
        run: |
          echo "üîç –ê–Ω–∞–ª–∏–∑ –∫–æ–¥–∞..."
          flutter analyze --no-fatal-infos || echo "‚ö†Ô∏è –ï—Å—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –≤ –∫–æ–¥–µ, –Ω–æ —ç—Ç–æ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è —Å–±–æ—Ä–∫–∏"

      - name: Setup CocoaPods
        run: |
          echo "üçé –ù–∞—Å—Ç—Ä–æ–π–∫–∞ CocoaPods..."
          cd ios
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–µ—Ä—Å–∏—é CocoaPods
          echo "–í–µ—Ä—Å–∏—è CocoaPods: $(pod --version)"
          
          # –û–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π CocoaPods
          echo "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è CocoaPods..."
          pod repo update
          
          # –ü—Ä–æ–±—É–µ–º —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å –æ—Å–Ω–æ–≤–Ω—ã–º Podfile
          echo "–ü–æ–ø—ã—Ç–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å –æ—Å–Ω–æ–≤–Ω—ã–º Podfile..."
          if pod install --repo-update --verbose --clean-install; then
            echo "‚úÖ –û—Å–Ω–æ–≤–Ω–æ–π Podfile —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ"
          else
            echo "‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å –æ—Å–Ω–æ–≤–Ω—ã–º Podfile, –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π..."
            
            # –ë—ç–∫–∞–ø –æ—Å–Ω–æ–≤–Ω–æ–≥–æ Podfile
            cp Podfile Podfile.backup
            
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π Podfile
            cp Podfile.minimal Podfile
            
            # –û—á–∏—â–∞–µ–º –∏ –ø—Ä–æ–±—É–µ–º —Å–Ω–æ–≤–∞
            rm -rf Pods Podfile.lock
            
            echo "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º Podfile..."
            if pod install --repo-update --verbose --clean-install; then
              echo "‚úÖ –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π Podfile —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ"
            else
              echo "‚ùå –û—à–∏–±–∫–∞ –¥–∞–∂–µ —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º Podfile"
              exit 1
            fi
          fi
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
          echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö pods:"
          ls -la Pods/ | head -10

      - name: Check dependencies status
        run: |
          echo "üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
          flutter pub outdated || true
          cd ios && pod outdated || true
          
      - name: Verify iOS project structure
        run: |
          echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã iOS –ø—Ä–æ–µ–∫—Ç–∞..."
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–ª—é—á–µ–≤—ã–µ —Ñ–∞–π–ª—ã
          echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–ª—é—á–µ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤:"
          ls -la ios/Runner.xcodeproj/project.pbxproj && echo "‚úÖ project.pbxproj –Ω–∞–π–¥–µ–Ω" || echo "‚ùå project.pbxproj –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"
          ls -la ios/Runner/Info.plist && echo "‚úÖ Info.plist –Ω–∞–π–¥–µ–Ω" || echo "‚ùå Info.plist –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"
          ls -la ios/Pods/ && echo "‚úÖ Pods —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã" || echo "‚ùå Pods –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç"
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º Firebase –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
          echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ Firebase –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:"
          if [ -f "ios/Runner/GoogleService-Info.plist" ]; then
            echo "‚úÖ GoogleService-Info.plist –Ω–∞–π–¥–µ–Ω"
          else
            echo "‚ö†Ô∏è GoogleService-Info.plist –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç, –∫–æ–ø–∏—Ä—É–µ–º –∏–∑ –∫–æ—Ä–Ω—è..."
            if [ -f "google-service-info.json" ]; then
              cp google-service-info.json ios/Runner/GoogleService-Info.plist
              echo "‚úÖ GoogleService-Info.plist —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω"
            else
              echo "‚ùå –§–∞–π–ª Firebase –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω"
            fi
          fi
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º Flutter –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
          echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ Flutter –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:"
          ls -la ios/Flutter/Generated.xcconfig && echo "‚úÖ Generated.xcconfig –Ω–∞–π–¥–µ–Ω" || echo "‚ùå Generated.xcconfig –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º workspace
          echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ workspace:"
          ls -la ios/Runner.xcworkspace/ && echo "‚úÖ Workspace –Ω–∞–π–¥–µ–Ω" || echo "‚ùå Workspace –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"

      - name: Build iOS IPA (unsigned for AltStore)
        run: |
          echo "üî® –°–±–æ—Ä–∫–∞ IPA –¥–ª—è AltStore..."
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Å–µ –≥–æ—Ç–æ–≤–æ –∫ —Å–±–æ—Ä–∫–µ
          if [ ! -d "ios/Pods" ]; then
            echo "‚ùå –û—à–∏–±–∫–∞: CocoaPods –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
            exit 1
          fi
          
          # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∫–æ–¥ –ø–æ–¥–ø–∏—Å–∏ –¥–ª—è unsigned —Å–±–æ—Ä–∫–∏
          echo "–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–ª—è unsigned —Å–±–æ—Ä–∫–∏..."
          
          # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π xcconfig —Ñ–∞–π–ª –¥–ª—è unsigned —Å–±–æ—Ä–∫–∏
          cat > ios/Flutter/Unsigned.xcconfig << EOF
          #include "Generated.xcconfig"
          CODE_SIGN_IDENTITY=
          CODE_SIGNING_REQUIRED=NO
          CODE_SIGNING_ALLOWED=NO
          PROVISIONING_PROFILE_SPECIFIER=
          DEVELOPMENT_TEAM=
          EOF
          
          # –û–±–Ω–æ–≤–ª—è–µ–º Release.xcconfig –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è unsigned –Ω–∞—Å—Ç—Ä–æ–µ–∫
          cp ios/Flutter/Release.xcconfig ios/Flutter/Release.xcconfig.backup
          cp ios/Flutter/Unsigned.xcconfig ios/Flutter/Release.xcconfig
          
          # –ó–∞–ø—É—Å–∫–∞–µ–º —Å–±–æ—Ä–∫—É —Å –ø–æ–¥—Ä–æ–±–Ω—ã–º –≤—ã–≤–æ–¥–æ–º
          echo "–ó–∞–ø—É—Å–∫ flutter build ipa..."
          if flutter build ipa --release --no-codesign --verbose; then
            echo "‚úÖ –°–±–æ—Ä–∫–∞ IPA –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ"
          else
            echo "‚ùå –û—à–∏–±–∫–∞ —Å–±–æ—Ä–∫–∏ IPA, –ø—Ä–æ–±—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –º–µ—Ç–æ–¥..."
            
            # –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª
            cp ios/Flutter/Release.xcconfig.backup ios/Flutter/Release.xcconfig
            
            # –ü—Ä–æ–±—É–µ–º —Å–±–æ—Ä–∫—É iOS app bundle –≤–º–µ—Å—Ç–æ IPA
            echo "–ü—Ä–æ–±—É–µ–º —Å–±–æ—Ä–∫—É iOS app bundle..."
            if flutter build ios --release --no-codesign --verbose; then
              echo "‚úÖ –°–±–æ—Ä–∫–∞ iOS app –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ"
              
              # –°–æ–∑–¥–∞–µ–º IPA –≤—Ä—É—á–Ω—É—é –∏–∑ app bundle
              echo "–°–æ–∑–¥–∞–Ω–∏–µ IPA –∏–∑ app bundle..."
              mkdir -p build/ios/ipa
              cd build/ios/iphoneos
              
              # –ù–∞—Ö–æ–¥–∏–º .app —Ñ–∞–π–ª
              APP_NAME=$(find . -name "*.app" -type d | head -1)
              if [ -n "$APP_NAME" ]; then
                echo "–ù–∞–π–¥–µ–Ω app bundle: $APP_NAME"
                
                # –°–æ–∑–¥–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–ª—è IPA
                mkdir -p Payload
                cp -r "$APP_NAME" Payload/
                
                # –°–æ–∑–¥–∞–µ–º IPA —Ñ–∞–π–ª
                zip -r "../ipa/taste_smoke_ios.ipa" Payload/
                echo "‚úÖ IPA —Å–æ–∑–¥–∞–Ω –≤—Ä—É—á–Ω—É—é"
                
                cd ../../..
              else
                echo "‚ùå App bundle –Ω–µ –Ω–∞–π–¥–µ–Ω"
                exit 1
              fi
            else
              echo "‚ùå –û—à–∏–±–∫–∞ —Å–±–æ—Ä–∫–∏ iOS app"
              echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø—Ä–æ–µ–∫—Ç–∞..."
              ls -la ios/
              ls -la build/ || echo "–ü–∞–ø–∫–∞ build –Ω–µ —Å–æ–∑–¥–∞–Ω–∞"
              exit 1
            fi
          fi
          
      - name: Verify IPA creation
        run: |
          echo "‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–∑–¥–∞–Ω–Ω–æ–≥–æ IPA..."
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É build –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
          echo "–°—Ç—Ä—É–∫—Ç—É—Ä–∞ build/:"
          find build/ -type f -name "*.ipa" -o -name "*.app" 2>/dev/null || echo "–ù–µ—Ç IPA –∏–ª–∏ APP —Ñ–∞–π–ª–æ–≤"
          
          if [ -d "build/ios/ipa" ]; then
            echo "–ü–∞–ø–∫–∞ IPA –Ω–∞–π–¥–µ–Ω–∞:"
            ls -la build/ios/ipa/
            
            if ls build/ios/ipa/*.ipa 1> /dev/null 2>&1; then
              echo "IPA —Ñ–∞–π–ª—ã –Ω–∞–π–¥–µ–Ω—ã:"
              for ipa in build/ios/ipa/*.ipa; do
                echo "–§–∞–π–ª: $ipa"
                file "$ipa"
                echo "–†–∞–∑–º–µ—Ä: $(du -h "$ipa" | cut -f1)"
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ IPA
                echo "–°–æ–¥–µ—Ä–∂–∏–º–æ–µ IPA:"
                unzip -l "$ipa" | head -20
              done
            else
              echo "‚ùå IPA —Ñ–∞–π–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ –ø–∞–ø–∫–µ"
              exit 1
            fi
          else
            echo "‚ùå –ü–∞–ø–∫–∞ build/ios/ipa –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
            echo "–ü–æ–ª–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ build/:"
            find build/ -type f 2>/dev/null || echo "–ü–∞–ø–∫–∞ build –ø—É—Å—Ç–∞ –∏–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
            exit 1
          fi

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: taste-smoke-ios-altstore
          path: build/ios/ipa/*.ipa
          retention-days: 30

      - name: Debug build failure
        if: failure()
        run: |
          echo "üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –æ—à–∏–±–∫–∏ —Å–±–æ—Ä–∫–∏..."
          
          echo "=== –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞ ==="
          ls -la ios/
          
          echo "=== –°—Ç—Ä—É–∫—Ç—É—Ä–∞ build ==="
          find build/ -type f 2>/dev/null || echo "–ü–∞–ø–∫–∞ build –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
          
          echo "=== Xcode –ø—Ä–æ–µ–∫—Ç ==="
          ls -la ios/Runner.xcodeproj/
          ls -la ios/Runner.xcworkspace/ 2>/dev/null || echo "Workspace –Ω–µ –Ω–∞–π–¥–µ–Ω"
          
          echo "=== CocoaPods ==="
          ls -la ios/Pods/ 2>/dev/null || echo "Pods –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
          cat ios/Podfile.lock | head -20 2>/dev/null || echo "Podfile.lock –Ω–µ –Ω–∞–π–¥–µ–Ω"
          
          echo "=== Flutter –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è ==="
          ls -la ios/Flutter/
          cat ios/Flutter/Generated.xcconfig 2>/dev/null || echo "Generated.xcconfig –Ω–µ –Ω–∞–π–¥–µ–Ω"
          
          echo "=== –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏ —Å–±–æ—Ä–∫–∏ ==="
          find . -name "*.log" -mtime -1 2>/dev/null | head -5 | xargs tail -50 2>/dev/null || echo "–õ–æ–≥–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"

      - name: Upload build logs (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-debug
          path: |
            ios/Pods/
            build/
            ios/Flutter/
            ios/Runner.xcodeproj/
            ios/Podfile*
          retention-days: 7
