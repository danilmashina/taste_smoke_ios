name: Flutter iOS Build for AltStore (DISABLED)

on:
  workflow_dispatch: # –¢–æ–ª—å–∫–æ —Ä—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫

jobs:
  build:
    runs-on: macos-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.2'
          channel: 'stable'
          cache: true

      - name: Flutter Doctor
        run: flutter doctor -v

      - name: Clean project thoroughly
        run: |
          echo "üßπ –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞..."
          flutter clean
          rm -rf build
          rm -rf ios/Pods 
          rm -rf ios/Podfile.lock
          rm -rf ios/.symlinks
          rm -rf ios/Flutter/Flutter.framework
          rm -rf ~/Library/Developer/Xcode/DerivedData/*
          
      - name: Get Flutter dependencies
        run: |
          echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Flutter –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
          flutter pub get

      - name: Analyze Flutter code
        run: |
          echo "üîç –ê–Ω–∞–ª–∏–∑ –∫–æ–¥–∞..."
          flutter analyze --no-fatal-infos || echo "‚ö†Ô∏è –ï—Å—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –≤ –∫–æ–¥–µ, –Ω–æ —ç—Ç–æ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è —Å–±–æ—Ä–∫–∏"

      - name: Setup CocoaPods with enhanced error handling
        run: |
          echo "üçé –ù–∞—Å—Ç—Ä–æ–π–∫–∞ CocoaPods —Å —É–ª—É—á—à–µ–Ω–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫..."
          cd ios
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–µ—Ä—Å–∏—é CocoaPods –∏ Ruby
          echo "=== ENVIRONMENT CHECK ==="
          echo "CocoaPods –≤–µ—Ä—Å–∏—è: $(pod --version)"
          echo "Ruby –≤–µ—Ä—Å–∏—è: $(ruby --version)"
          echo "Gem –≤–µ—Ä—Å–∏—è: $(gem --version)"
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º Podfile –Ω–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏
          echo "=== PODFILE VALIDATION ==="
          echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ Podfile..."
          if ruby -c Podfile > /dev/null 2>&1; then
            echo "‚úÖ Podfile —Å–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∏ –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω"
          else
            echo "‚ùå –û—à–∏–±–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ –≤ Podfile"
            ruby -c Podfile
            exit 1
          fi
          
          # –û—á–∏—Å—Ç–∫–∞ –ø–µ—Ä–µ–¥ —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π
          echo "=== CLEANUP ==="
          rm -rf Pods Podfile.lock .symlinks
          
          # –û–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π CocoaPods
          echo "=== REPO UPDATE ==="
          echo "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è CocoaPods..."
          pod repo update --silent
          
          # –ü–æ–ø—ã—Ç–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å –æ—Å–Ω–æ–≤–Ω—ã–º Podfile
          echo "=== PRIMARY PODFILE INSTALL ==="
          echo "–ü–æ–ø—ã—Ç–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å –æ—Å–Ω–æ–≤–Ω—ã–º Podfile..."
          
          # –ó–∞–ø—É—Å–∫ —Å –¥–µ—Ç–∞–ª—å–Ω—ã–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º –æ—à–∏–±–æ–∫
          if pod install --repo-update --verbose --clean-install 2>&1 | tee ../pod_install.log; then
            echo "‚úÖ –û—Å–Ω–æ–≤–Ω–æ–π Podfile —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ"
            PODFILE_SUCCESS=true
          else
            echo "‚ùå –û—à–∏–±–∫–∞ —Å –æ—Å–Ω–æ–≤–Ω—ã–º Podfile"
            PODFILE_SUCCESS=false
            
            # –ê–Ω–∞–ª–∏–∑ –æ—à–∏–±–∫–∏
            echo "=== ERROR ANALYSIS ==="
            echo "–ü–æ—Å–ª–µ–¥–Ω–∏–µ 20 —Å—Ç—Ä–æ–∫ –ª–æ–≥–∞ pod install:"
            tail -20 ../pod_install.log
            
            echo "–ü–æ–∏—Å–∫ –∫–ª—é—á–µ–≤—ã—Ö –æ—à–∏–±–æ–∫:"
            grep -i "error\|exception\|abort" ../pod_install.log | head -5 || echo "–°–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
            exit 1 # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–±–æ—Ä–∫—É –∑–¥–µ—Å—å, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –æ—à–∏–±–∫—É
          fi

      - name: Add GoogleService-Info.plist to Xcode project
        run: |
          echo "üìù –î–æ–±–∞–≤–ª–µ–Ω–∏–µ GoogleService-Info.plist –≤ –ø—Ä–æ–µ–∫—Ç Xcode..."
          sudo gem install xcodeproj
          ruby - <<EOL
          require 'xcodeproj'

          project_path = 'ios/Runner.xcodeproj'
          file_to_add_path = 'Runner/GoogleService-Info.plist'
          target_name = 'Runner'

          project = Xcodeproj::Project.open(project_path)
          target = project.targets.find { |t| t.name == target_name }
          group = project.main_group.find_subpath('Runner', true)

          file_reference = group.new_file(file_to_add_path)
          target.add_file_references([file_reference])
          project.save

          puts "‚úÖ GoogleService-Info.plist –¥–æ–±–∞–≤–ª–µ–Ω –≤ –ø—Ä–æ–µ–∫—Ç."
          EOL

      - name: Check dependencies status
        run: |
          echo "üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
          flutter pub outdated || true
          cd ios && pod outdated || true
          
      - name: Build Xcode Archive
        run: |
          echo "üî® –°–æ–∑–¥–∞–Ω–∏–µ –∞—Ä—Ö–∏–≤–∞ Xcode..."
          flutter build ipa --release --no-codesign

      - name: Manually package IPA
        run: |
          echo "üì¶ –†—É—á–Ω–∞—è —É–ø–∞–∫–æ–≤–∫–∞ .ipa..."
          mkdir -p build/ios/ipa
          cd build/ios/archive
          mkdir -p Payload
          cp -r Runner.xcarchive/Products/Applications/Runner.app Payload/
          zip -r ../ipa/Runner.ipa Payload
          echo "‚úÖ .ipa —Å–æ–∑–¥–∞–Ω –≤—Ä—É—á–Ω—É—é."

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: taste-smoke-ios-altstore
          path: build/ios/ipa/*.ipa
          retention-days: 30
